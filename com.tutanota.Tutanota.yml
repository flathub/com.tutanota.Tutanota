id: com.tutanota.Tutanota
runtime: org.freedesktop.Platform
runtime-version: '23.08'
base: org.electronjs.Electron2.BaseApp
base-version: '23.08'
sdk: org.freedesktop.Sdk
command: tutanota-desktop
separate-locales: false
finish-args:
  # X11 performance
  - --share=ipc
  # OpenGL rendering
  - --device=dri
  # Access to wayland
  - --socket=wayland
  # Access to X11
  - --socket=x11
  # Audio Access
  - --socket=pulseaudio
  # Network Access
  - --share=network
  - --talk-name=org.freedesktop.secrets
  - --talk-name=org.kde.StatusNotifierWatcher
  - --env=TMPDIR=/var/tmp
  # File system Access
  - --filesystem=host:ro
  - --filesystem=xdg-desktop
  - --filesystem=xdg-documents
  - --filesystem=xdg-download
  - --filesystem=xdg-music
  - --filesystem=xdg-pictures
  - --filesystem=xdg-public-share
  - --filesystem=xdg-videos
  - --filesystem=xdg-run/keyring
  # Allow advanced input methods
  - --talk-name=org.freedesktop.portal.Fcitx
modules:
  - name: libsecret
    buildsystem: meson
    config-opts:
      - -Dmanpage=false
      - -Dvapi=false
      - -Dgtk_doc=false
      - -Dintrospection=false
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - /share/man
    sources:
      - type: git
        url: https://github.com/tutao/libsecret.git
        commit: 3d18f7e928d6de69457ec3d18d5ca84923191957
  - name: tutanota
    buildsystem: simple
    sources:
      - dest-filename: tutanota-unpacked-linux.tar.gz
        type: file
        sha256: 4dd8ef535da7875b137c64dd067fbb75b12e9da177f188c3bdc7849ece2245b0
        url: https://github.com/tutao/tutanota/releases/download/tutanota-desktop-release-3.119.3/tutanota-desktop-3.119.3-unpacked-linux.tar.gz
      - type: script
        dest-filename: tutanota-desktop.sh
        commands:
          - export TMPDIR="$XDG_RUNTIME_DIR/app/${FLATPAK_ID}"
          - exec zypak-wrapper /app/lib/tutanota/tutanota-desktop --ozone-platform-hint=auto "$@"
    build-commands:
      - tar -xf tutanota-unpacked-linux.tar.gz --transform="s/linux-unpacked/tutanota/" --directory="${FLATPAK_DEST}"
      - |
        for size in 64 512; do
          install -Dm0644 "${FLATPAK_DEST}/tutanota/resources/icons/icon/${size}.png" "${FLATPAK_DEST}/share/icons/hicolor/${size}x${size}/apps/com.tutanota.Tutanota.png"
        done
      - install -Dm755 tutanota-desktop.sh /app/bin/tutanota-desktop
  - name: metadata
    buildsystem: simple
    sources:
      - type: file
        path: com.tutanota.Tutanota.appdata.xml
      - type: file
        path: com.tutanota.Tutanota.desktop
    build-commands:
      - install -Dm644 com.tutanota.Tutanota.appdata.xml /app/share/appdata/com.tutanota.Tutanota.appdata.xml
      - install -Dm644 com.tutanota.Tutanota.desktop /app/share/applications/com.tutanota.Tutanota.desktop
