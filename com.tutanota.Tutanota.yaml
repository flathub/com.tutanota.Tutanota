app-id: com.tutanota.Tutanota
runtime: org.freedesktop.Platform
runtime-version: '20.08'
branch: stable
sdk: org.freedesktop.Sdk
base: org.electronjs.Electron2.BaseApp
base-version: '20.08'
command: tutanota-desktop
separate-locales: false
finish-args:
- "--share=ipc"
- "--socket=x11"
- "--socket=wayland"
- "--socket=pulseaudio"
- "--share=network"
- "--filesystem=host"
- "--talk-name=org.freedesktop.Notifications"
- "--env=TMPDIR=/var/tmp"
sdk-extensions:
- org.freedesktop.Sdk.Extension.node12
modules:
- shared-modules/libsecret/libsecret.json
- name: tutanota
  build-options:
    env:
      npm_config_cache: "/run/build/tutanota/npm-cache"
      electron_config_cache: "/run/build/tutanota/npm-cache"
      ELECTRON_BUILDER_CACHE: "/run/build/tutanota/npm-cache"
      ELECTRON_CACHE: "/run/build/tutanota/npm-cache"
      ELECTRON_SKIP_BINARY_DOWNLOAD: 1
  buildsystem: simple
  sources:
  - type: git
    url: https://github.com/tutao/tutanota.git
    tag: tutanota-release-3.76.10
    commit: d924275105b35ebafc3646479a6522e2c270eddc
  - type: patch
    path: dist.patch
  - generated-sources.json
  - dist-generated-sources.json
  - type: file
    path: package-lock.json
    dest: build/dist
  build-commands:
  - |
    . /usr/lib/sdk/node12/enable.sh
    chattr +i package-lock.json
    chmod ugo-wx package-lock.json
    npm install --unsafe-perm=true || exit 1
    node dist release -l || exit 1

  - mkdir -p /app/lib/
  - cp -r build/dist/installers/linux*-unpacked /app/lib/tutanota
  - ln -s /app/lib/tutanota/tutanota-desktop /app/bin/tutanota-desktop
  - install -Dm644 resources/desktop-icons/icon/512.png /app/share/icons/hicolor/512x512/apps/com.tutanota.Tutanota.png
  - install -Dm644 resources/desktop-icons/icon/64.png /app/share/icons/hicolor/64x64/apps/com.tutanota.Tutanota.png
- name: metadata
  buildsystem: simple
  sources:
  - type: file
    path: com.tutanota.Tutanota.appdata.xml
  - type: file
    path: com.tutanota.Tutanota.desktop
  build-commands:
  - install -Dm644 com.tutanota.Tutanota.appdata.xml /app/share/appdata/com.tutanota.Tutanota.appdata.xml
  - install -Dm644 com.tutanota.Tutanota.desktop /app/share/applications/com.tutanota.Tutanota.desktop
